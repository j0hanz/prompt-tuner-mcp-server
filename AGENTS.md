# AGENTS.md

## Project Overview

- **Name**: `@j0hanz/prompt-tuner-mcp-server`
- **Purpose**: MCP server that fixes and enhances prompts using OpenAI, Anthropic, or Google Gemini
- **Stack**: TypeScript, Node.js >= 22.0.0, MCP SDK, Zod v4
- **Transport**: stdio only (no HTTP)
- **Tools**: `fix_prompt` (grammar/spelling), `boost_prompt` (clarity/effectiveness)

## Repo Map / Structure

```text
src/
  index.ts        Entry point (bootstraps CLI + server)
  cli.ts          CLI parsing, logging, shutdown handling
  server.ts       MCP server setup (stdio transport)
  tools.ts        Tool implementations (fix_prompt, boost_prompt)
  schemas.ts      Zod input/output schemas
  config.ts       Configuration constants and validation
  types.ts        Shared types and error codes
  lib/
    errors.ts     Error handling utilities
    llm.ts        LLM provider abstraction (OpenAI, Anthropic, Google)
    prompt-utils.ts  Prompt processing helpers
    telemetry.ts  Diagnostics and telemetry

tests/
  unit.test.ts         Unit tests
  integration.test.ts  Integration tests

dist/             Compiled output (generated, gitignored)
docs/             Static assets (logo)
```

## Setup & Environment

- **Install deps**: `npm install`
- **Node version**: >= 22.0.0 (enforced via `engines`)
- **Env config**: Set via environment variables or CLI flags. See `CONFIGURATION.md` for full reference.

### Required environment variables

| Variable            | When required                 |
| ------------------- | ----------------------------- |
| `LLM_PROVIDER`      | Always (default: `openai`)    |
| `OPENAI_API_KEY`    | When `LLM_PROVIDER=openai`    |
| `ANTHROPIC_API_KEY` | When `LLM_PROVIDER=anthropic` |
| `GOOGLE_API_KEY`    | When `LLM_PROVIDER=google`    |

## Development Workflow

| Task             | Command             |
| ---------------- | ------------------- |
| Dev mode (watch) | `npm run dev`       |
| Build            | `npm run build`     |
| Start (compiled) | `npm run start`     |
| TypeScript watch | `npm run watch`     |
| MCP Inspector    | `npm run inspector` |

## Testing

| Task       | Command                 |
| ---------- | ----------------------- |
| All tests  | `npm run test`          |
| Watch mode | `npm run test:watch`    |
| Coverage   | `npm run test:coverage` |

- **Framework**: Node.js native test runner (`node:test`)
- **Test files**: `tests/*.test.ts`
- **Pattern**: `*.test.ts`

## Code Style & Conventions

- **Language**: TypeScript 5.x with ES2022 target
- **Lint**: `npm run lint` (ESLint with strict TypeScript rules)
- **Format**: `npm run format` (Prettier)
- **Type-check**: `npm run type-check`
- **Duplication check**: `npm run duplication` (jscpd)

### Enforced conventions

| Rule                          | Enforcement                                       |
| ----------------------------- | ------------------------------------------------- |
| Explicit return types         | ESLint error                                      |
| Type-only imports             | `import { type X }`                               |
| No unused imports             | ESLint auto-removes                               |
| Naming: camelCase, PascalCase | ESLint naming-convention                          |
| Strict null checks            | `noUncheckedIndexedAccess`                        |
| Prefer `const`, no `var`      | ESLint error                                      |
| Use Zod v4 syntax             | See `.github/instructions/zod-v4.instructions.md` |

### Import order (Prettier plugin)

Imports are auto-sorted by the `@trivago/prettier-plugin-sort-imports` plugin.

## Build / Release

- **Build output**: `dist/` (generated by `npm run build`)
- **Entry point**: `dist/index.js` (executable, chmod 755)
- **Release trigger**: GitHub release → CI runs lint, type-check, test, build → publishes to npm
- **Versioning**: Extracted from git tag (e.g., `v1.2.3` → `1.2.3`)
- **Registry**: npm (Trusted Publishing via OIDC)

### Pre-publish checks

The `prepublishOnly` script runs: `npm run lint && npm run type-check && npm run build`

## Security & Safety

- API keys are supplied only via environment variables (never hardcoded)
- Inputs validated with Zod schemas + length checks
- Error context sanitized and truncated (max 200 chars) when `INCLUDE_ERROR_CONTEXT=true`
- Google safety filters disabled only via explicit `GOOGLE_SAFETY_DISABLED=true`
- No secrets in logs; use `DEBUG=true` only for troubleshooting

## Pull Request / Commit Guidelines

### Required checks before PR

```bash
npm run format
npm run lint
npm run type-check
npm run build
npm run test
```

### Commit format

- Use clear, descriptive commit messages
- Include summary of changes, tests run, and any configuration changes

### CI checks (on release publish)

1. `npm run lint`
2. `npm run type-check`
3. `npm run test`
4. `npm run build`

## Troubleshooting

| Issue               | Solution                                               |
| ------------------- | ------------------------------------------------------ |
| Prompt rejected     | Shorten prompt or increase `MAX_PROMPT_LENGTH`         |
| Timeout errors      | Increase `LLM_TIMEOUT_MS` or reduce `LLM_MAX_TOKENS`   |
| Rate limit errors   | Increase `RETRY_BASE_DELAY_MS` or `RETRY_MAX_ATTEMPTS` |
| Build errors        | Run `npm run type-check` to see TypeScript errors      |
| ESLint failures     | Run `npm run lint` and fix reported issues             |
| Import order issues | Run `npm run format` to auto-sort imports              |

## Agent Operating Rules

1. **Search before edit**: Use `fs-context/grep` or `fs-context/find` before modifying files
2. **Read before changing**: Always read `CONFIGURATION.md` before changing config behavior
3. **Verify changes**: Run `npm run lint && npm run type-check && npm run test` after edits
4. **No destructive commands**: Avoid `rm -rf`, prefer targeted file operations
5. **Use Zod v4**: Follow `.github/instructions/zod-v4.instructions.md` for schema changes
6. **MCP patterns**: Follow `.github/instructions/typescript-mcp-server.instructions.md`
