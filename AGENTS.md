# AGENTS.md

## Project Overview

- PromptTuner MCP is a Model Context Protocol (MCP) server that refines, analyzes, optimizes, and validates prompts.
- Runtime: Node.js, TypeScript (ESM, NodeNext). Transport is stdio (no HTTP transport implemented; the dev:http and start:http scripts are aliases).
- LLM providers supported via environment variables: OpenAI, Anthropic, Google (Gemini).

## Repo Map / Structure

- src/
  - index.ts: CLI entrypoint (parses flags, applies env overrides, starts server)
  - server.ts: MCP server wiring (stdio transport) + tool/prompt/resource registration
  - config/: env parsing, constants, instructions, patterns, types
  - lib/: LLM clients/providers, validation, output normalization, telemetry, helpers
  - tools/: MCP tool implementations (analyze/optimize/refine/validate)
  - prompts/: prompt templates (quick workflows)
  - resources/: template resources exposed via MCP
  - schemas/: Zod schemas for inputs/outputs and LLM responses
- tests/: node:test suites (TypeScript via tsx loader)
- dist/: compiled output (generated by build)
- docs/: static assets (logo)
- logs/: local logs/artifacts (ignored by git)

## Setup & Environment

- Node.js: package.json requires >= 22.0.0
- Package manager: npm (package-lock.json is present)
- Install dependencies (CI-style): npm ci
- Install dependencies (local dev): npm install

Environment configuration:

- Configuration is via environment variables and documented in CONFIGURATION.md.
- Secrets (API keys) must be provided via env vars in your MCP client config (or a local .env that you create; .env is gitignored).

Required env vars (pick one provider and set its key):

- LLM_PROVIDER: openai | anthropic | google
- OPENAI_API_KEY (when LLM_PROVIDER=openai)
- ANTHROPIC_API_KEY (when LLM_PROVIDER=anthropic)
- GOOGLE_API_KEY (when LLM_PROVIDER=google)

Useful optional env vars (see CONFIGURATION.md for full list):

- LLM_MODEL
- LLM_TIMEOUT_MS
- LLM_MAX_TOKENS
- MAX_PROMPT_LENGTH
- RETRY_MAX_ATTEMPTS, RETRY_BASE_DELAY_MS, RETRY_MAX_DELAY_MS, RETRY_TOTAL_TIMEOUT_MS
- DEBUG
- INCLUDE_ERROR_CONTEXT
- GOOGLE_SAFETY_DISABLED

## Development Workflow

- Dev mode (watch, runs from src): npm run dev
- TypeScript watch only: npm run watch
- Build (compiles to dist/): npm run build
- Run compiled server: npm run start

Inspector:

- Run MCP Inspector against the built server: npm run inspector

CLI flags:

- Run prompt-tuner-mcp-server --help for supported flags.
- Flags override environment variables for LOG_FORMAT, DEBUG, INCLUDE_ERROR_CONTEXT, LLM_PROVIDER, LLM_MODEL, LLM_TIMEOUT_MS, LLM_MAX_TOKENS, MAX_PROMPT_LENGTH.

## Testing

- Run all tests: npm run test
- Watch mode: npm run test:watch
- Coverage: npm run test:coverage

Notes:

- Tests use node:test with the tsx loader (see package.json test scripts).
- Tests live under tests/ and are named \*.test.ts.

## Code Style & Conventions

- Language: TypeScript (strict) targeting ES2022.
- Module system: ESM (package.json type: module) with NodeNext resolution.
- Imports:
  - Local TypeScript imports use .js file extensions (NodeNext/ESM output).
  - Prefer type-only imports/exports when applicable.

Formatting:

- Prettier is configured via .prettierrc and includes @trivago/prettier-plugin-sort-imports.
- Format command: npm run format

Linting:

- ESLint uses a flat config (eslint.config.mjs).
- Lint command: npm run lint

Type checking:

- Type-check command: npm run type-check

Repository-local guidance:

- .github/instructions/typescript-mcp-server.instructions.md describes MCP/TS SDK conventions used in this repo.

## Build / Release

- Build output directory: dist/
- Build command: npm run build
- Prepublish checks: npm run prepublishOnly (lint + type-check + build)

CI / publishing:

- GitHub Actions workflow: .github/workflows/publish.yml
- Runs on release publication and performs: npm ci, lint, type-check, test, build, then publishes to npm.
- Publishing uses npm Trusted Publishing (OIDC), not NODE_AUTH_TOKEN.

## Security & Safety

- Do not commit API keys or .env files (they are gitignored).
- Error context inclusion is opt-in via INCLUDE_ERROR_CONTEXT; when enabled, context is sanitized and truncated.
- Logging is written to stderr; avoid writing non-MCP data to stdout when running in stdio mode.
- Google safety filters can be disabled only via GOOGLE_SAFETY_DISABLED=true.

## Pull Request / Commit Guidelines

- No explicit commit-message convention is defined in-repo.
- Before opening a PR, run the same checks as CI:
  - npm run lint
  - npm run type-check
  - npm run test
  - npm run build
